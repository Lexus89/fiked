/*
 * fiked - a fake IKE PSK+XAUTH daemon based on vpnc
 * Copyright (C) 2005, Daniel Roethlisberger <daniel@roe.ch>
 * 
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, see http://www.gnu.org/copyleft/
 * 
 * $Id$
 */



// Overview

This is an implementation of MITM against IKE PSK+XAUTH, or more
correctly, just a fake IKE daemon supporting just enough of the
standards to attack the common Cisco based PSK+XAUTH VPN setups.

Basically, if you know the pre-shared key, also known as shared secret
or group password, you can impersonate the VPN gateway and learn XAUTH
user credentials.  There are several ways to get the pre-shared key,
including being a legitimate user, grabbing it from accidentally
disclosed client configuration files, or brute forcing it from the
aggressive mode plain text r_hash.

This attack [1] is not new.  It has been known for a long time that IKE
using PSK with XAUTH is insecure, which is also why XAUTH was not
accepted as an IETF standard, and this is probably not the first actual
implementation of the attack.

This implementation is very limited in scope.  The only supported
configuration is IKE aggressive mode using PreShared Keys (PSK) and
XAUTH.  The only supported algorithm suite is 3DES-CBC, MD5, DH group 2.
Main mode is not supported, but that could be easily implemented too.

Based on this work, a full MITM attack could be implemented, but there
seems to be little point to do so.



// Attack Setup

To successfully demostrate an attack on a VPN site, you must be able to
intercept the IKE traffic between the clients and the VPN gateway.  Ways
to achieve this include posing as a legit 802.11 access point using
hostap, transparently tapping into Ethernet cables at a suitable
location, or ARP spoofing.  You must be able to redirect the IKE traffic
to a machine running fiked.

If you don't know how to set all it up, you probably should not be
running fiked in the first place.  This is not ready to run out of the
box on purpose.



// Requirements

You need libgcrypt [3] to build and run fiked.  If you are not running
FreeBSD, you might need to do some minor tweaking to the source to get
it to compile, but since it uses strictly C99, it should be fairly
portable.  Please do send me patches.



// References

[1] http://www.cisco.com/warp/public/707/cisco-sn-20040415-grppass.shtml
[2] http://www.unix-ag.uni-kl.de/~massar/vpnc/
[3] http://directory.fsf.org/security/libgcrypt.html


